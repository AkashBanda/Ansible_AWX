- hosts: all
  vars_files:
    - /root/Ansible/var.yml
  tasks:
    - name: Get the current date in YYYY-MM-DD format
      ansible.builtin.command: "date +%F"
      register: current_date

    - name: Ensure the date-based backup directory exists
      ansible.builtin.file:
        path: "/opt/backup/SN/{{ current_date.stdout }}"
        state: directory
        mode: '0755'
        
    - shell: "ls | wc -l"
      args:
        chdir: "/opt/backup/SN/{{ current_date.stdout }}/"
      register: count

    - set_fact:
        b: "{{ count.stdout | int + 1 }}" 

    - name: Creating Directory for Backup
      file:
        path: "/opt/backup/SN/{{ current_date.stdout }}/{{ b }}"
        state: directory
        mode: "0755"
        
    - name: Taking backup for ManagementServices.jar
      command: "mv /home/akash.banda/Wizall/Management/Apps/ManagementServices.jar /opt/backup/SN/{{ current_date.stdout }}/{{ b }}/"
      when: service == "ManagementServices"
      
#    - name: Taking backup for ManagementServices.jar
#      copy:
#         src: "/opt/Application/SN_Wizall/MobifinApps/Management/Apps/ManagementServices.jar"
#         dest: "/opt/backup/SN/{{ current_date.stdout }}/{{ b }}/"
#         remote_src: yes
#      when: service == "ManagementServices" 


    - name: Moving ManagementServices dependencies directory
      command: "mv /home/akash.banda/Wizall/Management/dependencies /opt/backup/SN/{{ current_date.stdout }}/{{ b }}/"
      when: service == "ManagementServices"
      
#    - name: Taking backup for ManagementServices dependencies
#      copy:
#         src: "/opt/Application/SN_Wizall/MobifinApps/Management/dependencies"
#         dest: "/opt/backup/SN/{{ current_date.stdout }}/{{ b }}/"
#         remote_src: yes
#      when: service == "ManagementServices"

    - name: Depploying ManagementService.jar on Management service
      copy: 
         src: "/root/Ansible/Wizall/MFS-WizallMW/ManagementServices/target/ManagementServices.jar"
         dest: "/home/akash.banda/Wizall/Management/Apps/"
      when: service == "ManagementServices" 

    - name: Deploying Management dependencies on Management Service
      copy:
         src: "/root/Ansible/Wizall/MFS-WizallMW/ManagementServices/target/dependency-jars/"
         dest: "/home/akash.banda/Wizall/Management/dependencies/"
      when: service == "ManagementServices"   

    - name: Restarting ManagementServices
      service:
         name: "SN_MFS_Mgnt.service"
         state: "restarted"
      when: service == "ManagementServices"   
         

      
